<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="nb" xmlns="http://www.w3.org/1999/xhtml" lang="nb">

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <title>SignertKryptertBundle - Legemiddeldata fra institusjon til Legemiddelregisteret
        v0.9.4</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="http://hl7.org/fhir" />

    <link type="text/css" href="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/css/jquery-ui.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/css/pygments-manni.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/css/prism.css" />
    <link type="text/css" href="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/css/cqf.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
    <link href="assets/css/fhir.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/fhi.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/project.css" rel="stylesheet" type="text/css" />

    <style>
    

    

    

    </style>


    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <link rel="icon" sizes="32x32" href="assets/images/favicon.ico" />
</head>

<body onload="document.body.style.opacity='1'">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/js/prism.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/js/mermaid.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/js/mermaid-init.js"></script>
    <div id="segment-header" class="segment"> <!-- segment-header -->
        <div class="container"> <!-- container -->
            
            <!-- Placeholder for child template header declarations -->


<header class="fhi-header mb-0">
    <div class="fhi-header__brand">
        <div class="container fhi-header__brand-container">
            <div class="fhi-header__brand-content">
                <a class="fhi-header__logo" href="index.html">
                    <i class="icon-fhi-logo fhi-header__logo-icon"></i>
                    <span class="visually-hidden">FHI Produktnavn</span>
                </a>
                <div class="fhi-header__project">
                    <span class="fhi-header__project-name d-inline">Legemiddeldata fra institusjon til Legemiddelregisteret<span style="display:inline;" class="tagline"> &mdash; 0.9.4 - ci-build
                            
                            
                            
                            <img alt=" flag" src="assets/images/zwe.svg" height="16"
                                title="" />
                            
                            
                        </span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

            
        </div> <!-- /container -->
    </div> <!-- /segment-header -->

    <div class="container fhi-header__main-menu-container">
    <nav class="fhi-main-menu fhi-main-menu--open">
        <div class="container fhi-main-menu__container">
            <div [animation]="false" class="collapse fhi-main-menu__collapse">
                <div id="menu">
                    <!-- menu.xml  -->

<ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <li>
    <a href="index.html">Hjem</a>
  </li>
  <li>
    <a href="informasjonsmodell.html">Informasjonsmodell</a>
  </li>
  <li>
    <a href="integrasjon.html">Integrasjon</a>
  </li>
  <li>
    <a href="profiler.html">FHIR profiler</a>
  </li>
  <li>
    <a href="nedlastinger.html">Nedlastinger</a>
  </li>
</ul>
                </div>
            </div>
        </div>
    </nav>
</div>

    <div id="segment-breadcrumb" class="segment"> <!-- segment-breadcrumb -->
        <div class="container p-0"> <!-- container -->
            <ul class="breadcrumb p-2 mb-1">
                <li><a href='toc.html'><b>Table of Contents</b></a></li><li><a href='integrasjon.html'><b>Integrasjon</b></a></li><li><b>SignertKryptertBundle</b></li>
                
            </ul>
        </div> <!-- /container -->
    </div> <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment"> <!-- segment-content -->
        <div class="container"> <!-- container -->
            <div class="row">
                <div class="inner-wrapper">

<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
  












    <p><!-- white space is critical inside of capture --></p>
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#1-opprett-fhir-ressurs" id="markdown-toc-1-opprett-fhir-ressurs">1. Opprett FHIR-ressurs</a></li>
  <li><a href="#2-komprimer-med-gzip" id="markdown-toc-2-komprimer-med-gzip">2. Komprimer med GZip</a></li>
  <li><a href="#3-krypter-med-aes-gcm-256-bits-nøkkel" id="markdown-toc-3-krypter-med-aes-gcm-256-bits-nøkkel">3. Krypter med AES-GCM (256-bits nøkkel)</a></li>
  <li><a href="#4-krypter-aes-nøkkelen-med-rsa-legemiddelregisterets-offentlige-nøkkel" id="markdown-toc-4-krypter-aes-nøkkelen-med-rsa-legemiddelregisterets-offentlige-nøkkel">4. Krypter AES-nøkkelen med RSA (Legemiddelregisterets offentlige nøkkel)</a></li>
  <li><a href="#5-signer-kryptert-innhold-avsenders-private-nøkkel" id="markdown-toc-5-signer-kryptert-innhold-avsenders-private-nøkkel">5. Signer kryptert innhold (avsenders private nøkkel)</a></li>
  <li><a href="#6-opprett-og-fyll-ut-signertkryptertbundle-objektet" id="markdown-toc-6-opprett-og-fyll-ut-signertkryptertbundle-objektet">6. Opprett og fyll ut SignertKryptertBundle-objektet</a></li>
</ul>

</div>
<p>Når data skal leveres fra institusjoner til Legemiddelregisteret skal dette sendes i en <code class="language-plaintext highlighter-rouge">SignertKryptertBundle</code>. Denne lages ved å komprimere <code class="language-plaintext highlighter-rouge">LegemiddelregisteretBundle</code>, kryptere og signere innholdet.</p>

<p>Her beskrives hvordan du må gå frem for å lage en <code class="language-plaintext highlighter-rouge">SignertKryptertBundle</code> som skal sendes til Legemiddelregisterets API. Implementasjonsdetaljer (språk, biblioteker osv.) står du fritt til å velge, så lenge resultatet samsvarer med spesifikasjonen under.</p>

<p><img src="signertkryptertbundle.svg" width="50%" />
<br clear="all" /></p>

<h3 id="1-opprett-fhir-ressurs">1. Opprett FHIR-ressurs</h3>

<p>Først lages en JSON-representasjon av FHIR-ressursen <code class="language-plaintext highlighter-rouge">LegemiddelregisterBundle</code>. Dette krever at følgende er satt:</p>

<ul>
  <li><strong>Status</strong> (obligatorisk, f.eks. <code class="language-plaintext highlighter-rouge">completed</code>, <code class="language-plaintext highlighter-rouge">in-progress</code> etc.)</li>
  <li><strong>Medication</strong> (kan være en referanse, ID eller en <code class="language-plaintext highlighter-rouge">Medication</code>-ressurs)</li>
</ul>

<p>Bruk standardbiblioteker eller tredjepartsbiblioteker for FHIR hvis ønskelig. Viktig at JSON-strukturen er korrekt for FHIR-standarden slik at validering i Legemiddelregisterets API ikke feiler. Valider gjerne FHIR-ressursen lokalt før kryptering for å unngå at meldinger feiler i serveren.</p>

<h3 id="2-komprimer-med-gzip">2. Komprimer med GZip</h3>

<p>For å redusere båndbredde og sikre at krypteringsprosessen er effektiv, må dataene GZip-komprimeres<br />
Resultatet blir en byte-array av komprimerte data. GZip benytter DEFLATE-algoritmen og er en standardisert og velprøvd metode.</p>

<p>I Java kan man typisk bruke klasser fra java.util.zip. I .NET finnes tilsvarende funksjonalitet i System.IO.Compression.</p>

<p>Resultatet etter GZip-komprimering skal være en byte-array som inneholder den komprimerte FHIR-JSONen.</p>

<h3 id="3-krypter-med-aes-gcm-256-bits-nøkkel">3. Krypter med AES-GCM (256-bits nøkkel)</h3>

<ol>
  <li><strong>Generer AES-nøkkel og nonce</strong>
    <ul>
      <li>Nøkkelen skal være 256 bits (32 bytes).</li>
      <li><code class="language-plaintext highlighter-rouge">nonce</code> (initialiseringsvektor) skal være 96 bits (12 bytes).  Denne skal genereres tilfeldig hver gang en kryptering utføres.</li>
    </ul>
  </li>
  <li><strong>Krypter med AES-GCM</strong>
    <ul>
      <li>
        <p>Krypter den komprimerte byte-arrayen med AES-GCM. I Java er dette tilgjengelig via AES/GCM/NoPadding, mens i .NET er det tilgjengelig via f.eks. AesGcm (fra .NET 5/6 og nyere).</p>
      </li>
      <li>Merk at AES-GCM vil generere en autentiseringstag (typisk 128 bits = 16 bytes).</li>
      <li>Ut fra krypteringen får du:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">encryptedContent</code> (selve cipher-teksten)</li>
          <li><code class="language-plaintext highlighter-rouge">authenticationTag</code> (brukes til å validere at innholdet ikke er endret)</li>
        </ul>
      </li>
      <li>AES-256-GCM gir både konfidensialitet (kryptering) og integritet (autentiseringstag) uten behov for en separat HMAC.</li>
    </ul>
  </li>
</ol>

<h3 id="4-krypter-aes-nøkkelen-med-rsa-legemiddelregisterets-offentlige-nøkkel">4. Krypter AES-nøkkelen med RSA (Legemiddelregisterets offentlige nøkkel)</h3>

<p>Den 256-bits AES-nøkkelen fra steg 3 krypteres med Legemiddelregisterets offentlige RSA-nøkkel.  Dette er tilgjengelig i sertifikatene som kan lastes ned <a href="nedlastinger.html">her</a></p>

<p>Algoritmen skal være RSA OAEP med SHA-256 (RSAEncryptionPadding.OaepSHA256). Resultatet er et byte-array <code class="language-plaintext highlighter-rouge">encryptedKey</code>.</p>

<p>Legemiddelregisterets offentlige RSA-nøkkel hentes fra Legemiddelregisterets virksomhetssertifikat. Thumbprintet til sertifikatet som benyttes skal angis som <code class="language-plaintext highlighter-rouge">encryptionCertificateThumbprint</code> i <code class="language-plaintext highlighter-rouge">SignertKryptertBundle</code>.</p>

<h3 id="5-signer-kryptert-innhold-avsenders-private-nøkkel">5. Signer kryptert innhold (avsenders private nøkkel)</h3>
<p>For at Legemiddelregisteret skal være sikre at innholdet faktisk kommer fra rett organisasjon (integritets- og autentisitetskontroll), må meldingen signeres:</p>

<ol>
  <li>Finn avsenders private nøkkel
    <ul>
      <li>Avsender bruker sitt sertifikat (med tilhørende privat nøkkel) til signering.</li>
      <li>Avsenders sertifikat har også en unik thumbprint, som skal oppgis i meldingen som <code class="language-plaintext highlighter-rouge">signatureCertificateThumbprint</code>.</li>
    </ul>
  </li>
  <li>Opprett hash av det krypterte innholdet
    <ul>
      <li>Bruk SHA-256 for å lage en hash av <code class="language-plaintext highlighter-rouge">encryptedContent</code>.</li>
    </ul>
  </li>
  <li>Signer hashen (RSA-PKCS1-v1.5)
    <ul>
      <li>Bruk privat nøkkel til avsenders sertifikat for signaturen.</li>
      <li>Resultatet lagres som en byte-array i <code class="language-plaintext highlighter-rouge">signature</code>.</li>
    </ul>
  </li>
  <li>Oppgi avsenders organisasjonsidentifikator
    <ul>
      <li>Dette er en OID eller annen identifikator som knyttes til avsenders sertifikat.</li>
      <li>Serveren vår vil verifisere at avsenders sertifikat (gitt ved <code class="language-plaintext highlighter-rouge">signatureCertificateThumbprint</code>) faktisk har denne organisasjonsidentifikatoren.</li>
    </ul>
  </li>
</ol>

<h3 id="6-opprett-og-fyll-ut-signertkryptertbundle-objektet">6. Opprett og fyll ut SignertKryptertBundle-objektet</h3>

<p>Alle felter skal samles i et JSON-objekt med nøyaktig rekkefølge som nedenfor. Anta at binære data konverteres til Base64-strenger.</p>

<table>
  <thead>
    <tr>
      <th>Felt</th>
      <th>Type</th>
      <th>Beskrivelse</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>messageId</strong></td>
      <td>string</td>
      <td>Unik identifikator for meldingen. Gjerne en UUID</td>
    </tr>
    <tr>
      <td><strong>senderOrganizationIdentifier</strong></td>
      <td>string</td>
      <td>Avsenders organisasjons-ID eller OID (vanligvis organisasjonsnummer) som skal samsvare med sertifikat brukt for signering.</td>
    </tr>
    <tr>
      <td><strong>messageFormatVersion</strong></td>
      <td>string</td>
      <td>Gjeldende meldingsformat-versjon: <code class="language-plaintext highlighter-rouge">"1.0"</code>.</td>
    </tr>
    <tr>
      <td><strong>rapporteringFra</strong></td>
      <td>string</td>
      <td>Angir starttidspunkt for tidsperioden som dataene er hentet fra. Tidspunktet skal være i norsk lokaltid formattert etter ISO 8601, for eksempel: <code class="language-plaintext highlighter-rouge">2025-01-22T10:30:00Z</code></td>
    </tr>
    <tr>
      <td><strong>rapporteringTil</strong></td>
      <td>string</td>
      <td>Angir sluttidspunkt for tidsperioden som dataene er hentet fra. Tidspunktet skal være i norsk lokaltid formattert etter ISO 8601</td>
    </tr>
    <tr>
      <td><strong>encryptedContent</strong></td>
      <td>string</td>
      <td>AES-GCM-kryptert innhold (FHIR-ressursen komprimert og kryptert). Angis som Base64-encodet string.</td>
    </tr>
    <tr>
      <td><strong>encryptionCertificateThumbprint</strong></td>
      <td>string</td>
      <td>Thumbprint for sertifikatet som ble brukt til kryptering.</td>
    </tr>
    <tr>
      <td><strong>nonce</strong></td>
      <td>string</td>
      <td>96-bits nonce (12 bytes) brukt ved AES-GCM-krypteringen. Angis som Base64-encodet string.</td>
    </tr>
    <tr>
      <td><strong>authenticationTag</strong></td>
      <td>string</td>
      <td>128-bits (16 bytes) autentiseringstag fra AES-GCM. Angis som Base64-encodet string.</td>
    </tr>
    <tr>
      <td><strong>signatureCertificateThumbprint</strong></td>
      <td>string</td>
      <td>Thumbprint for avsenders sertifikat (med tilhørende privat nøkkel som ble brukt for signering).</td>
    </tr>
    <tr>
      <td><strong>signature</strong></td>
      <td>string</td>
      <td>Signatur (RSA-PKCS1-v1.5 over SHA-256 hash) av kryptert innhold. Angis som Base64-encodet string.</td>
    </tr>
    <tr>
      <td><strong>generatedAt</strong></td>
      <td>string</td>
      <td>Tidspunkt (norsk lokaltid) når meldingen ble generert.</td>
    </tr>
  </tbody>
</table>




</div>
</div> <!-- /inner-wrapper -->
</div> <!-- /row -->
</div> <!-- /container -->
</div> <!-- /segment-content -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/js/jquery.js"> </script>
<!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/js/jquery-ui.min.js"> </script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/HL7/ig-template-base@master/content/assets/js/window-hash.js"> </script>
<a name="bottom"> </a>
<footer id="segment-footer" igtool="footer" class="segment"> <!-- segment-footer -->
    <div class="container"> <!-- container -->
        <div class="container-fluid">
            
            <div class="inner-wrapper p-3">
                <p class="m-0">
                    IG &#169; 2024+ <a style="color:var(--footer-hyperlink-text-color)"
                        href="https://www.fhi.no">Folkehelseinstituttet</a>.
                    Package hl7.fhir.no.lmdi#0.9.4 based on <a
                        style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR
                        4.0.1</a>. Generated <span
                        title="Mon, Feb 17, 2025 16:05+0000">2025-02-17</span>
                    <br />
                    <span style="color: var(--footer-highlight-text-color)">
                                  Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                
                    </span>
                </p>
            </div> <!-- /inner-wrapper -->
        </div>
    </div><!-- /container -->
</footer> <!-- /segment-footer -->

<div id="segment-post-footer" class="segment hidden d-none"> <!-- segment-post-footer -->
    <div class="container"> <!-- container -->
    </div> <!-- /container -->
</div> <!-- /segment-post-footer -->

<!-- JS and analytics only. -->
<!-- Bootstrap core JavaScript
  ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"> </script>
<script type="text/javascript" src="assets/js/respond.min.js"> </script>
<script type="text/javascript" src="assets/js/anchor.min.js"> </script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>
<script type="text/javascript" src="assets/js/anchor-hover.js"> </script>
<script id="page-data" type="application/json">
  {
    "breadcrumb": "<li><a href='toc.html'><b>Table of Contents</b></a></li><li><a href='integrasjon.html'><b>Integrasjon</b></a></li><li><b>SignertKryptertBundle</b></li>"
  }
</script>
<script type="text/javascript">
    const pageData = JSON.parse(document.getElementById("page-data").textContent);

    const secondLevel = (key) => {
        if (pageData.breadcrumb) {
            const liRegex = /<li>(.*?)<\/li>/g;
            const listItems = [...pageData.breadcrumb.matchAll(liRegex)].map(match => match[1].trim());
            return listItems[1]?.includes(key) || false;
        }
        return false;
    };

    // Style FHI menu
    const menu = document.getElementById('menu');
    const ul = menu.querySelector('ul');
    ul.classList.add('nav', 'nav-tabs', 'fhi-nav-tabs', 'fhi-main-menu__nav');
    ul.querySelectorAll('li').forEach(li => {
        li.classList.add('fhi-main-menu__nav-item');
        li.querySelectorAll('a').forEach(a => {
            a.classList.add('nav-link', 'fhi-main-menu__nav-link');
        });

        if (li.classList.contains('dropdown')) {
            li.addEventListener('click', () => {
                li.classList.toggle('show');
                li.querySelector('ul').classList.toggle('show');
            });
        }
    });

    // Set active class on menu item
    const path = window.location.pathname;
    const page = path.split("/").pop();
    const menuItems = document.querySelectorAll('.fhi-main-menu__nav-item');
    menuItems.forEach(item => {
        const menuLink = item.querySelector('a').getAttribute('href');
        if (menuLink === page) {
            item.classList.add('active');
            item.querySelector('a').classList.add('active');
        }
        else if (secondLevel(menuLink)) {
            item.classList.add('active');
            item.querySelector('a').classList.add('active');
        }
    });

    // Init clipboard.js
    new ClipboardJS('.btn-copy');
</script>
<!-- Analytics Below
  ================================================== -->
</body>

</html>

